<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>智足管家</title>
    <link rel="stylesheet" href="../../js/plugin/layui/css/layui.css">
    <link rel="stylesheet" href="../../js/plugin/toastr/toastr.min.css">
    <link rel="stylesheet" href="../../font/iconfont.css">
    <link rel="stylesheet" href="../../css/common.css">
    <link rel="stylesheet" href="../../js/plugin/layui/css/login.css" media="all">
    <link rel="stylesheet" href="../../js/plugin/layui/css/admin.css">
    <style>
        /* .layui-fluid, .layui-fluid>.layui-row {
            width: 100%;
            height: 100%;
        }
        .layui-fluid>.layui-row {
            overflow-y: auto;
        }
        .row-item{
            height: 100%;
        } */
        .layui-fluid {
            padding: 20px;
        }
        .user.layui-form {
            padding: 0 20px;
        }
        .user-trends {
            padding-left: 20px;
        }
        .user-trends>h2 {
            background: #fff;
            height: 40px;
            
        }
        .user-trends>h2 span {
            display: inline-block;
            height: 100%;
            line-height: 40px;
            padding: 0 6px;
            border-bottom: 2px solid #009688!important;
        }
        .avatar-img {
            margin: 10px auto;
            height: 120px;
            width: 120px;
            border-radius: 50%;
        }

        .user-info {
            padding: 20px 0;
            background: #fff;
        }

        .user-info .layui-form-item {
            text-align: center;
        }

        .user-info .layui-form-label {
            width: 130px;
        }

        .user-info .layui-input-block {
            margin-left: 130px;
        }
        .up-pw {
            padding: 6px 8px;
            cursor: pointer;
        }
        .layui-input-inline.margin4 {
            margin: 4px 0;
        }
        .layui-upload-img {
            height: auto;
            width: 82px;
        }
        
    </style>
</head>

<body>
    <div class="layui-fluid">
        <div class="layui-row ">
            <div class="layui-col-xs4 user-info row-item">
                <form class="layui-form user" lay-filter="user">
                    <div class="base-info">
                        <div class="layui-form-item">
                            <img src="" alt="点击修改" id="avatarImg" class="avatar-img">
                        </div>
                        <div class="layui-form-item">
                            <span id="updatapw" class="layui-bg-blue up-pw">点击修改密码</span>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">
                                用户名
                            </label>
                            <div class="layui-input-block">
                                <input type="text" name="username" required lay-verify="required" placeholder="请输入用户名"
                                    autocomplete="off" class="layui-input" disabled >
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">
                                手机号码
                            </label>
                            <div class="layui-input-block">
                                <input type="text" name="mobile" required lay-verify="phone" placeholder="请输入手机号码"
                                    autocomplete="off" class="layui-input"  disabled>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">
                                姓名
                            </label>
                            <div class="layui-input-block">
                                <input type="text" name="realname" required lay-verify="required" placeholder="请输入姓名"
                                    autocomplete="off" class="layui-input"  disabled>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">
                                身份证号码
                            </label>
                            <div class="layui-input-block">
                                <input type="text" name="cardno" required lay-verify="identity" placeholder="请输入身份证号码"
                                    autocomplete="off" class="layui-input"  disabled>
                            </div>
                        </div>
                    </div>
                    <div class="doctor-info">
                        <div class="layui-form-item">
                            <label class="layui-form-label">
                                职称/职务
                            </label>
                            <div class="layui-input-block">
                                <select name="position" lay-verify="required" lay-search="">
                                    <option value="">请选择职称/职务</option>
                                    <option value="1">主治医师</option>
                                    <option value="2">复主治医师</option>
                                    <option value="3">主任医师</option>
                                    <option value="4">住院医师</option>
                                    <option value="5">其他</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">
                                所属医院及科室
                            </label>
                            <div class="layui-input-block">
                                <div class="layui-input-inline margin4">
                                    <select name="hospital_id" lay-search="" id="hospitalSelect" lay-filter="hospital"
                                        required lay-verify="required">

                                    </select>
                                </div>
                                <div class="layui-input-inline margin4">
                                    <select name="organizationId" lay-search="" id="organizationSelect" required
                                        lay-verify="required">

                                    </select>
                                </div>
                            </div>

                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">
                                从业资格证
                            </label>
                            <div class="layui-input-block">
                                <div class="layui-input-inline margin4">
                                    <button type="button" class="layui-btn" id="license">
                                        <i class="layui-icon">&#xe64a;</i>点击上传执照
                                    </button>
                                </div>
                                <div class="layui-input-inline margin4">
                                    <img class="layui-upload-img" id="licenseImg">
                                    <p id="licenseImgText"></p>
                                </div>
                            </div>
                            

                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">
                                擅长
                            </label>
                            <div class="layui-input-block">
                                <input type="text" name="adept" placeholder="请输入擅长" autocomplete="off"
                                    class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">
                                个人简介
                            </label>
                            <div class="layui-input-block">
                                <textarea placeholder="请简单的我描述" class="layui-textarea" name="introduction"></textarea>
                            </div>
                        </div>
                        <div class="submit-register-box text-center">
                            <button class="layui-btn layui-btn-normal" lay-submit
                                lay-filter="submitUpdata">确定修改</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="layui-col-xs8 row-item trends">
                <div class="user-trends">
                    <h2>
                        <span>个人动态</span>
                    </h2>
                   
                </div>

            </div>
        </div>
    </div>
    <div id="updataPWlayer" style="display: none;" class="up-pw">
        <form class="layui-form layadmin-user-login-box layadmin-user-login-body">
            <div class="layui-form-item">
                <label class="layadmin-user-login-icon layui-icon layui-icon-password"
                    for="LAY-user-login-password"></label>
                <input type="text" name="password" id="LAY-user-login-password" lay-verify="required"
                    placeholder="旧密码" class="layui-input">
            </div>
            <div class="layui-form-item">
                <label class="layadmin-user-login-icon layui-icon layui-icon-edit"
                    for="LAY-user-login-password"></label>
                <input type="text" name="newPwd" id="LAY-user-login-password" lay-verify="required"
                    placeholder="新密码密码" class="layui-input">
            </div>
            <div class="layui-form-item">
                <label class="layadmin-user-login-icon layui-icon layui-icon-edit"
                    for="LAY-user-login-password"></label>
                <input type="text" name="repeatPwd" id="LAY-user-login-password" lay-verify="required"
                    placeholder="确认新密码密码" class="layui-input">
            </div>
            <div class="layui-form-item">
                <div class=" text-center">
                    <button class="layui-btn layui-btn-normal" id="upPW" lay-submit
                        lay-filter="upPW">确定修改</button>
                </div>
            </div>
        </form>
    </div>
    <script src="../../js/plugin/jquery.min.js"></script>
    <script src="../../js/plugin/jquery.cookie.js"></script>
    <script src="../../js/plugin/toastr/toastr.min.js"></script>
    <script src="../../js/plugin/layui/layui.js"></script>
    <script src="../../js/common/config.js"></script>
    <script src="../../js/common/common.js"></script>
    <script>
        layui.use(['layer', 'upload', 'form', 'jquery'], function () {
            var form = layui.form,
                upload = layui.upload,
                layer = layui.layer,
                $ = layui.$;
            // 获取 医院
            var hospitalsURL = AJAX_API.common.gethospitals;
            ajaxRequest(hospitalsURL, "GET", {}, "", function (res) {
                if (res.code == 200) {
                    var data = res.data;
                    var html = ['<option value="">请选择医院</option>']
                    $.each(data, function (i, item) {
                        html.push('<option value="' + item.id + '">' + item.hospital + '</option>')
                    })
                    $("#hospitalSelect").html(html.join(""))
                    form.render('select')
                }
            })
            var utoken = $.cookie("utoken");
            // 获取用户信息
            if (!utoken) {
                parent.layer.msg('您尚未登陆或者,或者登陆已过期，请重登陆', {
                    time: 20000, //20s后自动关闭
                    btn: ['重新登陆'],
                    btn1: function () {
                        parent.window.location.href = "../../../login_doctor.html"
                    }
                });
            }
            access_token = JSON.parse(utoken).access_token;
            var roleInfoUlr = AJAX_API.user.userInfo
            ajaxRequest(roleInfoUlr, "get", {}, access_token, function (res) {
                if (res.code == 200) {
                    var userData = res.data;
                        userData.organizationId = userData.department_id;
                    
                    var organizationId = userData.hospital_id;
                    getOrganization(organizationId,form,true,userData)
                    $("#avatarImg").attr("src",userData.avatar).attr("userid",userData.userid)
                    if(userData.license) {
                        $("#licenseImg").attr("src", userData.license)
                    }
                   
                }
            })
            form.on('select(hospital)', function (data) {
                var val = data.value;
                getOrganization(val,form)
            })
            // 修改密码
            form.on('submit(upPW)', function (obj) {
                var pw = obj.field;
                if(pw.newPwd !=pw.repeatPwd) {
                    layer.msg("密码与确认密码不一致,请验证后重新输入")
                }else {
                    ajaxRequest(AJAX_API.user.resetPwd, "post", JSON.stringify(pw), access_token, function(res){
                        if(res.code == 200 ) {
                            top.layer.msg(res.message)
                        }
                    })
                }
                return false
            })
            // 修改信息
            form.on('submit(submitUpdata)', function (obj) {
                var updata = obj.field;
                updata.avatar = $("#avatarImg").attr("src") || "";
                updata.license = $("#licenseImg").attr("src") || "";
                var userId = $("#avatarImg").attr("userid")
                if(userId) {
                    updata.userId = userId;
                    ajaxRequest(AJAX_API.user.register, "post", JSON.stringify(updata), access_token, function(res){
                        if(res.code == 200 ) {
                            top.layer.msg(res.message)
                        }
                    })

                }
                console.log(updata)
                return false
            })
            $("#updatapw").on("click",function(){
                layer.open({
                    type:1,
                    title:"修改密码",
                    content:$("#updataPWlayer"),
                    area: ['420px', '310px'],
                    skin: 'layui-layer-lan',
                })
            })

             //  上传执照
             var uploadLicenseOption = {
                upload:upload,
                elem:"#license",
                url:ajaxRoot + AJAX_API.upImg.license,
                imgElem:$("#licenseImg"),
                imgTextElem:$("#licenseImgText"),
                cb:function(){
                    top.layer.msg("上传成功,请点击确定修改,修改执照")
                }
            }
            var licenseInst = uploadInst (uploadLicenseOption)
            // 上传头像
            var uploadAvaterOption = {
                upload:upload,
                elem:"#avatarImg",
                imgElem:$("#avatarImg"),
                url:ajaxRoot + AJAX_API.upImg.avater,
                cb:function(){
                    top.layer.msg("上传成功,请点击确定修改,修改头像")
                }
            }
            var avaterInst = uploadInst (uploadAvaterOption)
            // 获取科室
            function getOrganization(id,form,init,obj) {
                if (id) {
                    //  获取科室
                    var organizationURL = AJAX_API.common.getdepartments + id;
                    ajaxRequest(organizationURL, "GET", {}, "", function (res) {
                        if (res.code == 200) {
                            var data = res.data;
                            var html = ['<option value="">请选择科室</option>']
                            $.each(data, function (i, item) {
                                html.push('<option value="' + item.organizationId + '">' + item.organizationName + '</option>')
                            })
                            $("#organizationSelect").html(html.join(""))
                            if(init) {
                                form.val("user", obj)
                            }
                            form.render('select')
                        }
                    })
                }
            }
        })
    </script>
</body>

</html>